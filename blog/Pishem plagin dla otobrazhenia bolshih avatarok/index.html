<!DOCTYPE html> <html lang="en"> <head> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111024724-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-111024724-1'); </script> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Пишем плагин для отображения больших аватарок</title> <meta name="description" content="В данной статье подробно разбирается по шагам, как создать свой плагин отображения больших аватаров в конструкторе RPG Maker MV."> <link rel="canonical" href="https://murlab.github.io/blog/Pishem%20plagin%20dla%20otobrazhenia%20bolshih%20avatarok/"> <link rel="alternate" type="application/rss+xml" title="Mur Laboratory" href="/feed.xml"> <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" /> <link rel="icon" type="image/png" href="/favicon.png" /> <link rel="stylesheet" type="text/css" href="/css/font-awesome.css" /> <link rel="stylesheet" type="text/css" href="/css/main.css" /> <script type="text/javascript" src="/js/main.js"></script> <link rel="stylesheet" href="/css/highlight/monokai-sublime.css"> <script src="/js/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();</script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Article", "headline": "Пишем плагин для отображения больших аватарок", "image": "https://murlab.github.io/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/avatars_title.png", "keywords": [ "archive", "rpg maker mv", "plugins", "javascript", "story", "уроки" ], "datePublished": "2015-11-05", "dateModified": "2015-11-05", "articleSection": "rpg_maker", "author": { "@type": "Person", "name": "Mur" }, "creator": { "@type": "Person", "name": "Mur" }, "publisher": { "@type": "Organization", "name": "Mur Lab", "logo":"https://murlab.github.io/images/avatar.png" }, "articleBody": "Всем привет! С вами опять я, и мои очумелые ручки вновь не дают мне покоя. Ну и собственно по этой причине я спешу поделиться с вами своим новыми изысканиями. Изыскивать мы сегодня будем как с помощью нескольких изменений, вывести на экран большие аватарки. На подобии «Message busts» от Galv. Стой лишь разницей, что у него скрипт написан для VX Ace, ну а мы соответственно будем изыскивать для RPG Maker MV. ", "mainEntityOfPage": "True" } </script> </head> <body onload="init();"> <div class="center"> <div class="header"> <div class="topLogo"></div> <div class="topMenuAdd"> <a href="/files/" class="topMenuItem" title="Файлы для скачивания"><i class="fa fa-download" aria-hidden="true"></i></a> <a href="/feed.xml" class="topMenuItem" title="Подписаться на RSS"><i class="fa fa-rss" aria-hidden="true"></i></a> </div> </div> <div id="navbar" class="topMenu"> <div class="topMenuLeft"></div> <div class="topMenuCenter"> <span class="topMenuSpace">&nbsp;</span> <span><a href="/blog/" class="topMenuItem active"><i class="fa fa-paw" aria-hidden="true"></i><br>Блог</a></span> <span><a href="/graphics/" class="topMenuItem"><i class="fa fa-pencil" aria-hidden="true"></i><br>Графика</a></span> <span><a href="/misc/" class="topMenuItem"><i class="fa fa-code" aria-hidden="true"></i><br>Разное</a></span> <span><a href="/rpg_maker/" class="topMenuItem"><i class="fa fa-diamond" aria-hidden="true"></i><br>RPG Maker</a></span> <span><a href="/godot/" class="topMenuItem"><i class="fa fa-cogs" aria-hidden="true"></i><br>Godot</a></span> <span><a href="/about/" class="topMenuItem"><i class="fa fa-github-alt" aria-hidden="true"></i><br>Мур?</a></span> </div> <div class="topMenuRight"></div> <a href="/"><div class="topMenuAvatar"></div></a> <div class="popupMenu"> <input id="popupMenuInput" type="checkbox" name="menu"/> <label id="popupMenuLabel" for="popupMenuInput"><span class="fa fa-bars topMenuIcon" aria-hidden="true"></span></label> <ul class="menu"> <li><a href="/blog/" class="popupMenuItem active"><i class="fa fa-paw" aria-hidden="true"></i>Блог</a></li> <li><a href="/graphics/" class="popupMenuItem"><i class="fa fa-pencil" aria-hidden="true"></i>Графика</a></li> <li><a href="/misc/" class="popupMenuItem"><i class="fa fa-code" aria-hidden="true"></i>Разное</a></li> <li><a href="/rpg_maker/" class="popupMenuItem"><i class="fa fa-diamond" aria-hidden="true"></i>RPG Maker</a></li> <li><a href="/godot/" class="popupMenuItem"><i class="fa fa-cogs" aria-hidden="true"></i>Godot</a></li> <li><a href="/about/" class="popupMenuItem"><i class="fa fa-github-alt" aria-hidden="true"></i>Мур?</a></li> <li><div class="popupMenuLine"></div></li> <li><a href="/comments/" class="popupMenuItem"><i class="fa fa-comments-o" aria-hidden="true"></i> Новые комментарии</a></li> <li><a href="https://murlab.disqus.com/latest.rss" class="popupMenuItem"><i class="fa fa-rss" aria-hidden="true"></i> RSS комментариев</a></li> <li><div class="popupMenuLine"></div></li> <li><a href="/archive/" class="popupMenuItem"><i class="fa fa-archive" aria-hidden="true"></i> Архив постов</a></li> <li><div class="popupMenuLine"></div></li> <li><a href="/files/" class="popupMenuItem"><i class="fa fa-cloud-download" aria-hidden="true"></i> Cкачать файлы</a></li> <li><div class="popupMenuLine"></div></li> <li><a href="/tags/" class="popupMenuItem"><i class="fa fa-tags" aria-hidden="true"></i> Все тэги</a></li> <li><a href="/feed.xml" class="popupMenuItem"><i class="fa fa-rss" aria-hidden="true"></i> RSS лента</a></li> </ul> </div> </div> <div class="content"> <div class="post"> <div class="postHeader"> <div class="postStar"><i class="fa fa-flask" aria-hidden="true"></i></div> <div class="postDate"> 5 Ноября 2015 </div> <div class="postTitle">Пишем плагин для отображения больших аватарок</div> </div> <div class="postContent"> <div class="postImage"> <img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/avatars_title.png" /> </div> <div class="postBody"> <p>Всем привет!</p> <p>С вами опять я, и мои очумелые ручки вновь не дают мне покоя. Ну и собственно по этой причине я спешу поделиться с вами своим новыми изысканиями.</p> <p>Изыскивать мы сегодня будем как с помощью нескольких изменений, вывести на экран большие аватарки. На подобии «<a href="https://galvs-scripts.com/2012/12/01/message-busts/">Message busts</a>» от <a href="https://galvs-scripts.com/">Galv</a>. Стой лишь разницей, что у него скрипт написан для VX Ace, ну а мы соответственно будем изыскивать для RPG Maker MV.</p> <p>Для начала общая идея, как я себе это представляю: В обычном редакторе текстовых диалогов, мы выбираем файл с группой аватаров, выбираем один из них и задаём текст сообщения. Всё как обычно.</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/4.png" class="imgCenter" /></p> <p>Затем, находим место где выводится на экран аватарка. Изменяем скрипт на то что нам нужно, а именно выбрать картинку из папки img\bigfaces\ загрузить её вместо стандартной и вуаля, всё готово. На практике оказалось не всё так просто. Дело в том, что размеры окна (в данном случае с текстом сообщения) жестко задают границы и если попробовать загрузить другую (большую) картинку, то всё что попадает за пределы окна попросту обрезается.</p> <p>Довольно неожиданно, но мысль не давала мне покоя. Ну хорошо, а что, если нам сделать новое своё окошко, убрать к примеру все декорации, и загрузить в него нашу большую картинку. Отличная идея, как мне тогда казалось, но не совсем,… Да, новое большое окно у меня получилось вывести, но тут меня ждало разочарование. Дело в том, что как только новое окно перекрыло часть окна с сообщением, всё что находилось под ним попросту исчезло.</p> <p>Мдяя,… как говорится, а праздник был близко. Ну что ж, мы не отчаиваемся и самое время перестать маяться дурью и наконец посмотреть, а как же эту проблему решает Galv в своём скрипте? Всё оказалось просто. Скрипт, который выводит обычную аватарку убирается, а вместо него с помощью Sprite спокойно отображается картинка поверх всех окошек. Алллилуйя! Вот оно!</p> <p>Итак, идея ясна, осталось только всё сделать.</p> <p>Начнём мы, как и в прошлый раз с описания нашего скрипта. На деталях я останавливаться уже не стану, скажу только, что нам понадобится одна переменная в настройках, а именно сколько отступить тексту с левого края. Картинки у нас большие и если оставить настройки по умолчанию, то текст будет накладываться поверх персонажа, что не всегда хорошо читается. Впрочем, кто-то может в этом узреть особенность дизайна.</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/1.png" class="imgCenter" /></p> <p>Начало нашего скрипта:</p><pre><code class="javascript">//=============================================================================
// BigAvatar.js
//=============================================================================

/*:
* @plugindesc показывает большую аватарку
* @author Mur
*
* @param avatarWidth
* @desc padding for text
* @default 320
*
*/

(function() {

var parameters = PluginManager.parameters(‘BigAvatar’);
var avatarWidth = Number(parameters[‘avatarWidth’]);
</code></pre><p>Прочитаем в переменную avatarWidth ширину нашей большой картинки, или точнее сколько нам отступать.</p><pre><code class="javascript">var spr = new Sprite();
var bitmap;
var sprPosX;
</code></pre><p>Далее подготовим несколько переменных: <strong><em>spr</em></strong> это собственно наш спрайт с которым мы будем работать дальше; <strong><em>bitmap</em></strong> — сюда мы будем загружать нашу большую картинку и затем копировать в спрайт; <strong><em>sprPosX</em></strong> — это положение нашего спрайта на экране. Забегая немного вперёд скажу, что мне захотелось не просто вывести картинку на экран — БАМЦ! а что бы она плавно выезжала из-за края экрана. Но обо всём по порядку.</p><pre><code class="javascript">Window_Message.prototype.newLineX = function() {
	return $gameMessage.faceName() === '' ? 0 : avatarWidth;
};
</code></pre><p>Здесь мы указываем наш отступ для текста, если аватар не указан, то отступ равен 0. В противном случает отступ для текста устанавливается из нашей переменной <strong><em>avatarWidth</em></strong>.</p><pre><code class="javascript">Window_Base.prototype.drawFace = function(faceName, faceIndex, x, y, width, height) {
</code></pre><p>Далее собственно то место, где рисуется аватарка персонажа, который говорит наш текст.</p><pre><code class="javascript">if (faceName != '') {
</code></pre><p>Проверяем, а задано ли название аватара, который нам нужно отобразить. Уж не знаю или моя ошибка, или где-то кто-то что-то пропустил, но мы сюда иногда попадаем с пустым именем. В результате чего ошибка на экране и «поезд дальше никуда уже не идёт».</p> <p>Если имя не задано, то просто ничего не делаем.</p><pre><code class="javascript">if (spr.bitmap) {
	this.removeChild(spr);
}
</code></pre><p>Вот тут очень важный и интересный момент. Если у нас уже была загружена картинка (мы сюда попали не первый раз), то нужно убрать старый спрайт с экрана. Поскольку если этого не сделать на экране будет каша, все наши картинки начнут накладываться одна на другую.</p><pre><code class="javascript">bitmap = ImageManager.loadBitmap('img/bigfaces/' + faceName + '/', faceIndex+1, null, true);
</code></pre><p>Далее мы загружаем картинку. ‘img/bigfaces/’ — место где лежат наши большие аватарки. <strong><em>faceName</em></strong> это название файла с 8ю маленькими аватарками, который мы использовали при составлении текста. Но в данном случае это будет ещё одна папка, где будут лежать наши 8 больших картинок с номерами от 1 до 8. <strong><em>faceIndex+1</em></strong> это собственно уже название нашей картинки которую мы хотим загрузить. +1 потому что счёт у них не с 1, а 0. и «.png» не нужно добавлять, так как система сама это сделает за нас.</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/5.png" class="imgCenter" /></p> <p>Как видно из рисунка, «Тест» название нашего проекта «img\bigfaces» это где хранятся наши картинки «Package1» одноимённое название файла с аватарами и дальше собственно от 1 до 8 картинки.</p><pre><code class="javascript">var face = this;
</code></pre><p>Об этом чуть ниже.</p><pre><code class="javascript">bitmap.addLoadListener(function() {
</code></pre><p>Далее очень важный момент. Поскольку картинка не может загрузится мгновенно, нам нужно написать специальную нашу функцию, которая будет вызвана после того, как картинка будет загружена. Если этого не сделать на экране мы в лучшем случае не получим ничего, а в худшем случае ошибку.</p><pre><code class="javascript">spr.bitmap = new Bitmap(bitmap.width, bitmap.height);
</code></pre><p>После того, как картинка загружена, нам нужно её скопировать в спрайт. Для этого создадим пустую картинку в спрайте точно такими же размерами, как у вновь загруженной картинки.</p><pre><code class="javascript">spr.bitmap.blt(bitmap, 0, 0, bitmap.width, bitmap.height, 0, 0);
</code></pre><p>Затем копируем загруженную картинку <strong><em>bitmap</em></strong> в спрайт <strong><em>spr</em></strong>. Первые два числа (0,0) это координаты в нашей картинке, например, если мы хотим скопировать не всю, а только часть. Далее два числа (<strong><em>bitmap.width</em></strong>, <strong><em>bitmap.height</em></strong>) это собственно размер нашей копируемой картинки. Ну и последние два нуля это место куда мы хотим вставить нашу картинку в спрайт.</p><pre><code class="javascript">sprPosX = -(bitmap.width);
spr.x = sprPosX;
</code></pre><p>Здесь мы указываем начальную координату <strong><em>X</em></strong> для нашего спрайта. Как уже сказано выше, у меня есть задумка сделать так, чтобы спрайт появлялся не сразу на экране, а выезжал из-за границы экрана. Поэтому тут отрицательное число равное ширине нашей загруженной картинки.</p><pre><code class="javascript">spr.y = -(bitmap.height - face.height);
</code></pre><p>В этом месте задаётся вертикальное положение на экране, координата <strong><em>Y</em></strong>. Координата 0, как может показаться это не верхний левый угол экрана, а координата относительно нашего окна с текстом. Поэтому для того, чтобы «выскочить» за его границы нам так же нужно задать отрицательное число. Для этого берём высоту нашей картинки, уменьшаем её на высоту обычной аватарки и зададим координату Y.</p><pre><code class="javascript">face.addChildToBack(spr);
</code></pre><p>Ну и теперь главный момент. Собственно, надо «прикрепить» наш спрайт к окну с сообщением. Возможно есть способ лучше, и EvilCat меня поправит, но ничего лучше мне не пришло в голову. По идеи здесь должно быть написано было <strong><em>this.addChildToBack</em></strong>, но поскольку <strong><em>this</em></strong> у нас внутри нашей функции уже указывает на <strong><em>bitmap</em></strong>, то мы получим ошибку. Поэтому тут как бы такая вот странная конструкция, мы сохраняем в <strong><em>face</em></strong> наш старый <strong><em>this</em></strong> на окошко, а затем просим систему добавить к нему спрайт.</p><pre><code class="javascript">}.bind(bitmap));
</code></pre><p>Заканчивается загрузка картинки такой вот странной конструкцией. С радостью послушаю EvilCat для чего оно нужно, но скажу одно этот момент у меня очень много крови попил и заставил вчера просидеть аж почти до 4х утра. Пока не попался другой пример, с таким вот «хвостом». Уже отчаявшись, копирую этот кусочек и о чудо! Загрузка картинок заработала, иначе получались пустые файлы.</p><pre><code class="javascript">    }
};
</code></pre><p>Закрываем нашу проверку пустого имени и собственно всей функции.</p><pre><code class="javascript">var _Window_Base_close = Window_Base.prototype.close;
Window_Base.prototype.close = function() {
	_Window_Base_close.call(this);
	this.removeChild(spr);
};
</code></pre><p>Этот кусочек не менее важен чем другие и отнял у меня тоже достаточно много времени. Дело в том, что, когда мы загружаем картинки постепенно по мере открытия новых диалогов, всё красиво и прекрасно. Но если обратится к НПЦ ещё раз, на доли секунды на экране появляется старая (последняя) картинка, прежде чем успевает загрузится новая. Это не очень красиво, и логично было бы удалять наш спрайт с экрана, после закрытия окна с текстом.</p> <p>Думаю, комментарии тут излишни. Так же как и в первом уроке мы «дублируем» основную функцию системы <strong><em>Window_Base.prototype.close</em></strong> и добавляем после всех основных команд системы, команду удалить наш спрайт с экрана <strong><em>this.removeChild(spr)</em></strong>.</p><pre><code class="javascript">var _Window_Base_update = Window_Base.prototype.update;
Window_Base.prototype.update = function() {
	_Window_Base_update.call(this);
	if (sprPosX &lt;0) {
		sprPosX += 5;
		spr.x = sprPosX;
	}
};
</code></pre><p>Ну и осталась ещё одна функция, которая будет двигать наш спрайт из-за экрана до тех пор, пока координата <strong><em>X</em></strong> не будет равна 0.</p> <p>Так же как и с предыдущей функцией, мы делаем «дубликат» системной функции <strong><em>Window_Base.prototype.update</em></strong>. После того как отработает система, мы проверяем координату <strong><em>X</em></strong> нашего спрайта, и если она меньше 0, то увеличиваем её на 5 точек. Никаких дополнительных действий для загрузки изображения не требуется, достаточно обновить координату спрайта <strong><em>spr.x</em></strong> и оно сместиться на новое место автоматически.</p><pre><code class="javascript">})();
</code></pre><p>На этом всё, закрываем основную функцию нашего плагина и отправляемся тестировать.</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/3.png" class="imgCenter" /></p> <p>Стоит обратить внимание, что получившийся у нас плагин это всего лишь маленькая не законченная часть. Вывод аватара используется в совершенно неожиданных местах. И если, например, при отображении результатов битвы или списка персонажей в меню, это ещё не так фатально выглядит:</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/6.png" class="imgCenter" /></p> <p>то при выборе, например, экипировки:</p> <p><img src="/images.posts/2015.11/05 - Pishem plagin dla otobrazhenia bolshih avatarok/7.png" class="imgCenter" /></p> <p>уже выглядит не столь оптимистично.</p> <p>Понятно, что все эти нюансы ещё стоит учесть. Но минимальную задачу мы на сегодня выполнили. Разобрались как устроен вывод аватарок. Как загрузить свою картинку в спрайт и вывести на экран. И собственно, как сделать минимальную анимацию (выезд картинки из-за края экрана).</p> <p>На этом всё. Всем спасибо за внимание и до новых встреч. В следующий раз думаю мы ещё что-нибудь интересное расковыряем ;) Удачи!</p> <p><strong> Небольшое обновление</strong>:</p> <div class="hline"></div> <p>Для того, чтобы большие аватарки показывались только в сообщениях, собственно и нужно «трогать» только функцию сообщений, а не вообще всех аватарок.</p> <p>Поэтому вместо кусочка:</p><pre><code class="javascript">Window_Base.prototype.drawFace = function(faceName, faceIndex, x, y, width, height) {
</code></pre><p>Перед <strong><em>«if (faceName != ») {»</em></strong> надо написать:</p><pre><code class="javascript">Window_Message.prototype.drawMessageFace = function() {
var faceName = $gameMessage.faceName();
var faceIndex = $gameMessage.faceIndex();
</code></pre><p>Вот теперь будут заменяться аватарки только в сообщениях.</p> <p><strong> Ссылки по теме</strong>:</p> <div class="hline"></div> <ul> <li>Свежая версия скрипта <a href="https://github.com/murlab/rpg-maker-mv-plugins/blob/master/examples/BigAvatar.js">BigAvatar.js</a> всегда доступна на github в разделе <a href="https://github.com/murlab/rpg-maker-mv-plugins/blob/master/examples/">примеров</a></li> </ul> <div class="postTags"> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/archive/">archive</a></div> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/rpg maker mv/">rpg maker mv</a></div> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/plugins/">plugins</a></div> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/javascript/">javascript</a></div> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/story/">story</a></div> <div class="postTag"><i class="fa fa-tag" aria-hidden="true"></i> <a href="/tags/uroki/">уроки</a></div> </div> </div> <div class="postEnd"> <div class="postEndLineStart"></div> <div class="postEndCont"><a href="javascript:history.back();"><< Назад</a></div> <div class="postEndLineFinish"></div> </div> </div> <div id="disqus_thread"></div> <script> (function() { var d = document, s = d.createElement('script'); s.src = 'https://murlab.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> <div class="centerClean"></div> </div> </div> <div class="centerEnd"><div></div></div> <div class="footer">2014, 2017 &copy; Mur Laboratory</div> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111024724-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-111024724-1'); </script> </body> </html>
